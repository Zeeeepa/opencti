name: Block Critical Changes from Forks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-fork-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 is CRITICAL. Without it, you cannot diff against the base.
          fetch-depth: 0
      - name: Check for restricted file changes
        run: |
          # --- CONFIGURATION (The Array) ---
          # 1. Use parentheses ()
          # 2. distinct elements in quotes ""
          # 3. Space separated (newlines are treated as spaces by Bash)
          RESTRICTED_PATTERNS=(
            "^.circleci/"
            "^.github/"
            "^opencti-platform/config/"
            ".pre-commit-config.yaml"
            ".drone.yml"
            "renovate.json"
          )

          # --- LOGIC ---
          
          # Check for Fork
          if [ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]; then
            echo "✅ Team PR. Skipping."
            exit 0
          fi

          git fetch origin ${{ github.base_ref }} --depth=1
          
          # MAGIC HAPPENS HERE:
          # We use 'printf' to expand the array into newlines
          # Then pipe it to grep -f - (which reads patterns from Standard Input)
          
          CONFLICTS=$(git diff --name-only origin/${{ github.base_ref }} ${{ github.event.pull_request.head.sha }} | grep -f <(printf "%s\n" "${RESTRICTED_PATTERNS[@]}") || true)

          if [ -n "$CONFLICTS" ]; then
            echo "::error::⛔ BLOCKED. You touched restricted files:"
            echo "$CONFLICTS"
            exit 1
          fi

          echo "✅ No critical files modified. Proceeding."